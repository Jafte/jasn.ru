{% extends "blog/base.html" %}

{% load account static %}

{% block title %}{% if post %}Редактирование записи{% else %}Новая запись{% endif %}{% endblock %}

{% block content-container %}
    <h1>{% if post %}Редактирование записи{% else %}Новая запись{% endif %} в блоге {{ blog.title }}</h1>
    <div class="pure-g">
        <div class="pure-u-3-4">
            <form class="pure-form pure-form-aligned" method="post" enctype="multipart/form-data" action=".">
                {% csrf_token %}
                {% if post %}
                {% include "snippets/form_snippet_aligned.html" with form=form submit_text="Сохранить" reset_url=post.get_absolute_url reset_text="Вернуться к записи" %}
                {% else %}
                {% include "snippets/form_snippet_aligned.html" with form=form submit_text="Сохранить" %}
                {% endif %}
            </form>
        </div>
        <div class="pure-u-1-4">
            {% for image in images %}
                <div>
                    <img src="{{ image.image.list.url }}" alt="">
                </div>
                <div>
                    исходник: {{ image.image.url }}
                </div>
                <div>
                    600: {{ image.image.600.url }}
                </div>
                <div>
                    400: {{ image.image.400.url }}
                </div>
                <div>
                    200: {{ image.image.200.url }}
                </div>
            {% endfor %}
            <form>
                <input type="file" id="uploadfiles" multiple="multiple" >
                {% csrf_token %}
            </form>
            <script>
                var uploadfiles = document.querySelector('#uploadfiles');
                var csrftoken = document.querySelector("input[name='csrfmiddlewaretoken']");
                uploadfiles.addEventListener('change', function () {
                    var files = this.files;
                    for(var i=0; i<files.length; i++){
                        uploadFile(this.files[i]); // call the function to upload the file
                    }
                }, false);

                function uploadFile(file){
                    var url = '/api/v1/image/';
                    var xhr = new XMLHttpRequest();
                    var fd = new FormData();
                    xhr.open("POST", url, true);
                    xhr.onreadystatechange = function() {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            // Every thing ok, file uploaded
                            console.log(xhr.responseText); // handle response.
                        }
                    };
                    fd.append("image", file);
                    fd.append("csrftoken", csrftoken.value);
                    xhr.send(fd);
                }
            </script>
        </div>
    </div>
{% endblock %}